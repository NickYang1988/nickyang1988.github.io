<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>分享自定义静态断言代码 - C&#43;&#43;爱好者博客</title>
    <meta name="keywords" content="backend,game develop,programming,python,linux,vps,大数据,后端,游戏开发,服务器,机器学习,深度学习">
    
    <meta property="og:title" content="分享自定义静态断言代码">
    <meta property="og:site_name" content="C&#43;&#43;爱好者博客">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="分享自定义静态断言代码 - C&#43;&#43;爱好者博客" />
    <meta name="description" content="关注游戏开发，互联网动态，服务器，后端，大数据等相关内容"> 
    <link rel="shortcut icon" href="https://cppfans.org/img/favicon.ico" />
    <link rel="apple-touch-icon" href="https://cppfans.org/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="https://cppfans.org/img/apple-touch-icon.png" />
    <link href="https://cppfans.org/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="https://cppfans.org/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="https://cppfans.org/css/main.css" rel="stylesheet" type="text/css" />
    <link href="https://cppfans.org/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="https://cppfans.org"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">C&#43;&#43;爱好者博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Be a simple man.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="https://cppfans.org/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://cppfans.org/posts/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://cppfans.org/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://cppfans.org/links/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-link"></i> <br />友链
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="https://cppfans.org/1408.html" itemprop="url">
        分享自定义静态断言代码
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2012-11-21">
    2012-11-21
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="https://cppfans.org/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0" itemprop="url" rel="index">
        <span itemprop="name">技术文章</span>
      </a>
      &nbsp; 
    </span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="https://cppfans.org/categories/%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91" itemprop="url" rel="index">
        <span itemprop="name">程序开发</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">1275 字 ~3分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p>本文代码来自于QQ群中nous大神，类似于static assert，不过断言异常内容可以自定义。</p>

<p>代码分为boost版本和标准版本，使用ENSURE_HAS_BOOST 宏来区分。</p>

<p>代码：</p>

<pre>//
// ensure.hpp
//
// Copyright (c) Nous Xiong.
//
// Macro ENSURE impl.
//

#ifndef ENSURE_HPP
#define ENSURE_HPP

#ifdef ENSURE_HAS_BOOST

#include &lt;boost/exception/all&gt;
#include &lt;boost/thread/tss.hpp&gt;
#include &lt;boost/preprocessor/seq/for_each.hpp&gt;
#include &lt;boost/integer.hpp&gt;
#include &lt;stdexcept&gt;
#include &lt;sstream&gt;
#include &lt;iostream&gt;

namespace un
{
/// 运行时刻信息
typedef boost::error_info&lt;struct tag_runtime, std::string&gt; errinfo_runtime_t;

/// 专用于ensure的异常信息
typedef boost::error_info&lt;struct tag_ensure, std::string&gt; errinfo_ensure_t;

/// 异常基类
class exception
  : public virtual std::exception
  , public virtual boost::exception
{
};

class ensure
{
public:
  ensure()
    : current_function_(0)
    , file_(0)
    , line_(-1)
    , msg_(0)
  {
  }

  ~ensure()
  {
  }

public:
  ensure& set_context(char const* expr, char const* current_function, char const* file, int line)
  {
    msg_ = 0;
    err_.str("");
    err_ &lt;&lt; "Ensure failed, expression: '" &lt;&lt; expr &lt;&lt; "', values: ";
    current_function_ = current_function;
    file_ = file;
    line_ = line;

    // 这里你可以将std::cerr替换为你自己项目的日志系统
    std::cerr &lt;&lt;
      "Ensure failed point: [" &lt;&lt; file_ &lt;&lt; "]=[" &lt;&lt; line_ &lt;&lt; "]" &lt;&lt; std::endl;
    return *this;
  }

  ensure& set_current_val(boost::int8_t src, char const* name)
  {
    boost::int32_t tmp = (boost::int32_t)src;
    return set_val(tmp, name);
  }
  ensure& set_current_val(bool src, char const* name)
  {
    return set_val(src, name);
  }
  ensure& set_current_val(boost::int16_t src, char const* name)
  {
    return set_val(src, name);
  }
  ensure& set_current_val(boost::uint16_t src, char const* name)
  {
    return set_val(src, name);
  }
  ensure& set_current_val(boost::int32_t src, char const* name)
  {
    return set_val(src, name);
  }
  ensure& set_current_val(boost::uint32_t src, char const* name)
  {
    return set_val(src, name);
  }
  ensure& set_current_val(boost::int64_t src, char const* name)
  {
    return set_val(src, name);
  }
  ensure& set_current_val(boost::uint64_t src, char const* name)
  {
    return set_val(src, name);
  }
  ensure& set_current_val(std::string const& src, char const* name)
  {
    err_ &lt;&lt; name &lt;&lt; " = " &lt;&lt; src &lt;&lt; ", size: " &lt;&lt; src.size() &lt;&lt; "; ";
    return *this;
  }
  // 你可以加入任何你项目需要的数据类型
  // 例如：
  //ensure& set_current_val(my_data const& src, char const* name)
  //{
  //  err_ &lt;&lt; name &lt;&lt; " = " &lt;&lt; src.get_xxx() &lt;&lt; "; ";
  //  return *this;
  //}

  /// 用户可添加的消息
  ensure& set_current_val(char const* msg, char const*)
  {
    msg_ = msg;
    return *this;
  }

  /// 抛出异常
  template &lt;typename ExceptT&gt;
  ensure& set_current_val(ExceptT const& ex, char const*)
  {
    if (msg_)
    {
      ex &lt;&lt; errinfo_runtime_t(msg_);
    }
    ex &lt;&lt; errinfo_ensure_t(err_.str());
    boost::exception_detail::throw_exception_(ex, current_function_, file_, line_);
    return *this;
  }

  static ensure& get_ensure()
  {
    // 为了多线程下方便的使用ensure，这里使用了线程本地存储，
    // 如果是单线程程序，这里可以直接换为static ensure e;
    static boost::thread_specific_ptr&lt;ensure&gt; this_ens;
    ensure* ret = this_ens.get();
    if (!ret)
    {
      this_ens.reset(new ensure);
      ret = this_ens.get();
    }
    return *ret;
  }

private:
  template &lt;typename T&gt;
  ensure& set_val(T const t, char const* name)
  {
    err_ &lt;&lt; name &lt;&lt; " = " &lt;&lt; t &lt;&lt; "; ";
    return *this;
  }

private:
  std::stringstream err_;
  char const* current_function_;
  char const* file_;
  int line_;
  char const* msg_;
};
}

#define ENSURE_OP_IMPL(e, elem) e.set_current_val((elem), #elem); // 必须要定义这个宏，不然#elem无法正确的显示变量的字符串形式
#define ENSURE_OP(COLA_ENS, e, elem) ENSURE_OP_IMPL(e, elem)

#define ENSURE(expr, args) \
  if( (expr) ) ; \
  else \
  { \
    un::ensure& e = un::ensure::get_ensure(); \
    e.set_context(#expr, BOOST_CURRENT_FUNCTION, __FILE__, __LINE__); \
    BOOST_PP_SEQ_FOR_EACH(ENSURE_OP, e, args); \
  }

#else

#include &lt;stdexcept&gt;
#include &lt;sstream&gt;
#include &lt;iostream&gt;

namespace un
{
class ensure
{
public:
  ensure()
    : ENSURE_A(*this)
    , ENSURE_B(*this)
    , file_(0)
    , line_(-1)
    , msg_(0)
  {
  }

  ~ensure()
  {
  }

  ensure& ENSURE_A;
  ensure& ENSURE_B;

public:
  ensure& set_context(char const* expr, char const* file, int line)
  {
    msg_ = 0;
    err_.str("");
    err_ &lt;&lt; "Ensure failed, expression: '" &lt;&lt; expr &lt;&lt; "', values: ";
    file_ = file;
    line_ = line;

    // 这里你可以将std::cerr替换为你自己项目的日志系统
    std::cerr &lt;&lt;
      "Ensure failed point: [" &lt;&lt; file_ &lt;&lt; "]=[" &lt;&lt; line_ &lt;&lt; "]" &lt;&lt; std::endl;
    return *this;
  }

  ensure& set_current_val(char src, char const* name)
  {
    int tmp = (int)src;
    return set_val(tmp, name);
  }
  ensure& set_current_val(bool src, char const* name)
  {
    return set_val(src, name);
  }
  ensure& set_current_val(short src, char const* name)
  {
    return set_val(src, name);
  }
  ensure& set_current_val(int src, char const* name)
  {
    return set_val(src, name);
  }
  ensure& set_current_val(std::string const& src, char const* name)
  {
    err_ &lt;&lt; name &lt;&lt; " = " &lt;&lt; src &lt;&lt; ", size: " &lt;&lt; src.size() &lt;&lt; "; ";
    return *this;
  }
  // 你可以加入任何你项目需要的数据类型
  // 例如：
  //ensure& set_current_val(my_data const& src, char const* name)
  //{
  //  err_ &lt;&lt; name &lt;&lt; " = " &lt;&lt; src.get_xxx() &lt;&lt; "; ";
  //  return *this;
  //}

  /// 用户可添加的消息
  ensure& set_current_val(char const* msg, char const*)
  {
    msg_ = msg;
    return *this;
  }

  /// 抛出异常
  template &lt;typename ExceptT&gt;
  ensure& set_current_val(ExceptT const& ex, char const*)
  {
    if (msg_)
    {
      err_ &lt;&lt; "user msg = " &lt;&lt; msg_;
    }
    ex.set_error(err_.str()); // 需要用户实现这个方法
    throw ex;
    return *this;
  }

  static ensure& get_ensure()
  {
    // 仅仅单线程
    static ensure ret;
    return ret;
  }

private:
  template &lt;typename T&gt;
  ensure& set_val(T const t, char const* name)
  {
    err_ &lt;&lt; name &lt;&lt; " = " &lt;&lt; t &lt;&lt; "; ";
    return *this;
  }

private:
  std::stringstream err_;
  char const* file_;
  int line_;
  char const* msg_;
};
}

#define ENSURE_A(x) ENSURE_OP(x, B)
#define ENSURE_B(x) ENSURE_OP(x, A)

#define ENSURE_OP(x, next) \
  ENSURE_A.set_current_val((x), #x).ENSURE_##next

#define ENSURE(expr) \
  if( (expr) ) ; \
  else un::ensure::get_ensure().set_context(#expr,__FILE__,__LINE__).ENSURE_A

#endif

#endif /* COLA_ENSURE_HPP */</pre>

<p>测试代码：</p>

<pre>// ensure.cpp : Defines the entry point for the console application.
//
#include "ensure.hpp"

#ifdef ENSURE_HAS_BOOST

class my_except : public virtual un::exception {};

int main(int argc, char *argv[])
{
  try
  {
    boost::int32_t i = 0;
    std::string str("test str");
    ENSURE(i == 0 && str.empty(), (i)(str)("Test Ensure Msg")(my_except()));
    std::cout &lt;&lt; "Shouldn't be here." &lt;&lt; std::endl;
  }
  catch (my_except& ex)
  {
    std::cerr &lt;&lt; boost::diagnostic_information(ex) &lt;&lt; std::endl;
  }

    return 0;
}

#else

class my_except : public virtual std::exception
{
public:
  void set_error(std::string const& err) const
  {
    err_ = err;
  }

  virtual char const* what() const throw()
  {
    return err_.c_str();
  }

private:
  mutable std::string err_;
};

int main(int argc, char *argv[])
{
  try
  {
    int i = 0;
    std::string str("test str");
    ENSURE(i == 0 && str.empty())(i)(str)("Test Ensure Msg")(my_except());
    std::cout &lt;&lt; "Shouldn't be here." &lt;&lt; std::endl;
  }
  catch (my_except& ex)
  {
    std::cerr &lt;&lt; ex.what() &lt;&lt; std::endl;
  }

  system("pause");
  return 0;
}

#endif</pre>

<p><span style="color: #ff6600;"><strong>ensure下载地址：</strong></span></p>

<div class="button-group">
  <a class="button big" href="http://filemarkets.com/file/eliteYang/a77967c7/" target="_blank" rel="nofollow" >yunfile网盘</a><a class="button big" href="http://pan.baidu.com/share/link?shareid=121271&uk=2098050200" target="_blank" rel="nofollow" >百度网盘</a><a class="button big" href="http://w.qjwm.com/download.aspx?down=ok&filepath=eliteYang%2fensure.zip" target="_blank" rel="nofollow" >千军万马网盘</a><a class="button big" href="https://www.box.com/s/vcrk5wos5atokidrcyq1" target="_blank" rel="nofollow" >Box网盘</a>
</div>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="https://cppfans.org/tags/c&#43;&#43;" rel="tag" title="C&#43;&#43;">#C&#43;&#43;#</a>
    
    <a href="https://cppfans.org/tags/ensure" rel="tag" title="ensure">#ensure#</a>
    
    <a href="https://cppfans.org/tags/%e4%bb%a3%e7%a0%81%e5%88%86%e4%ba%ab" rel="tag" title="代码分享">#代码分享#</a>
    
    <a href="https://cppfans.org/tags/%e8%87%aa%e5%ae%9a%e4%b9%89%e5%bc%82%e5%b8%b8" rel="tag" title="自定义异常">#自定义异常#</a>
    
    <a href="https://cppfans.org/tags/%e9%9d%99%e6%80%81%e6%96%ad%e8%a8%80" rel="tag" title="静态断言">#静态断言#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="https://cppfans.org/1410.html" rel="next" title="对象序列化类库MsgPack介绍">
        <i class="fa fa-chevron-left"></i> 对象序列化类库MsgPack介绍
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="https://cppfans.org/1405.html" rel="prev" title="赏析某程序员寒冬自助暖手程序">
        赏析某程序员寒冬自助暖手程序 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     




    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="https://cppfans.org/img/author.jpg"
        alt="NickYang" />
    <p class="site-author-name" itemprop="name">NickYang</p>
    <p class="site-description motion-element" itemprop="description"> 
        Programmer &amp; Architect</p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="https://cppfans.org/post/">
        <span class="site-state-item-count">0</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="https://cppfans.org/categories/">      
         
        <span class="site-state-item-count">9</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="https://cppfans.org/tags/">
         
        <span class="site-state-item-count">418</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/NickYang1988/" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5b4f2ucxar6&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2019</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">C&#43;&#43;爱好者博客</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.59.0</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="https://cppfans.org/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="https://cppfans.org/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="https://cppfans.org/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="https://cppfans.org/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="https://cppfans.org/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="https://cppfans.org/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="https://cppfans.org/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="https://cppfans.org/js/utils.js"></script>
<script type="text/javascript" src="https://cppfans.org/js/motion.js"></script>
<script type="text/javascript" src="https://cppfans.org/js/affix.js"></script>
<script type="text/javascript" src="https://cppfans.org/js/schemes/pisces.js"></script>

<script type="text/javascript" src="https://cppfans.org/js/scrollspy.js"></script>
<script type="text/javascript" src="https://cppfans.org/js/post-details.js"></script>
<script type="text/javascript" src="https://cppfans.org/js/toc.js"></script>

<script type="text/javascript" src="https://cppfans.org/js/bootstrap.js"></script>

<script type="text/javascript" src="https://cppfans.org/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>